# 工場IoT技術検証用　プロトタイプ開発
## 01. アナログメーター読み取り

### 概要
    指針式メーター値の読み取り
    回転式数値カウンタ―の読み取り

### 開発環境・実行環境
* プラットフォーム
  Raspberry Pi 3 Model B
* カメラ
　Camera ver 2.1
* OS
  Raspbian Stretch with desktop and recommended software
	Version: November 2018	Kernel version:4.14

* 開発言語
    python 3.5
* ライブラリ
    OpenCV 3.1.0, NumPy, picamera

### ファイル構成
* MeterReaderES.py      ソース
* MeterTemplate.jpg     対象メータテンプレート画像
* calibration.ini       対象メータの設定ファイル
* README.md             本ファイル

### 実行方法
1. RaspberryPiコンソールで、python3でMeterReaderES.pyを実行する。
    * 対象メータ画像、およびカメラプレビューが表示されることを確認する。
2. 別途ファイラなどで対象メータ画像をRaspberryPiディスプレイ上表示し、カメラを向ける。
    * 対象メータを検知すると、プレビュー画面に緑の矩形が表示され、
    　別ウィンドウで読み取った指針の向きが矢印で表示される。
    * コンソールには読み取った値が出力される。
3. プレビュー画面右上の「×」を押下して終了


### 動作概要

1. カメラ起動、プレビュー画像取得
2. [メーター検出](#特徴点マッチングによるメーター検出)
3. [指針角度測定](#Hough変換を用いた指針角度測定)


## 処理詳細

### 特徴点マッチングによるメーター検出

OpenCVの特徴量検出とマッチング機能を用いて、メーターの検出と画像補正を行う。
入力はカメラからのプレビュー画像、出力はプレビュー画像から切り抜いたメーター画像である。

#### 処理
1. 対象メータテンプレート画像の読み込み
2. AKAZEモデル生成、テンプレート画像の特徴量算出
3. カメラキャプチャ画像の特徴量算出
4. テンプレート画像とキャプチャ画像の特徴量比較・マッチング
5. 適合した特徴点からホモグラフィ変換行列を求める。(RANSAC)
6. ホモグラフィ変換行列からキャプチャ画像上のテンプレート画像領域を算出し、矩形を描画
7. ホモグラフィ変換の逆行列を算出し、キャプチャ画像からメーター画像を切り出す。

#### パラメータ
* カメラ解像度（640×480）
* ホモグラフィ変換のアルゴリズム（RANSAC）
* 特徴点のマッチング精度（距離が60%以下）
* 画像のマッチング精度（10以上特徴点がマッチングした場合）

#### 課題
* マッチング精度のチューニング（特徴点のマッチング基準と、画像のマッチングの基準）
* 検出時のFPS（検出機能を実行すると10分の1になる）
* 複数のメーターの同時検出
* 他の特徴量算出アルゴリズムを試す



### Hough変換を用いた指針角度測定

OpenCVのHough変換機能を用いて、直線を検出、指針角度を算出する。
入力はメーター画像、出力は指針角度である。

#### 処理
1. 入力画像をグレイスケール化、二値化
2. 確率的Hough変換による直線検出
3. 検出した直線のフィルタリング・補正
	* 線分上に中心点がないものは棄却
	* 中心点より遠い点を終点、近い点を始点とする。
4. 角度算出
	* 残った線分の平均値を算出
5. 値変換
	* 最小角度から何度あるかの割合を算出し、最大値と最小値から現在値を算出する。


#### パラメータ
* 二値化閾値
* 直線検出のパラメータ（閾値、最小値、ギャップ）
* 直線のフィルタリング時の線分の幅（中心点を内包するかどうかの判定の幅）


#### 課題
* 画像解析用のパラメータの決定
* 検出した直線のうち、どれを採用するべきか？
	** どれも実際の指針の傾きと考えらない場合がある。
	** 突出した直線を検出する場合がある。
	** 指針の幅が太い、または極端に細い場合は検出できない場合がある。
	** 指針が直線でない、中心点から伸びていない場合
* 直線の方向の算出方法の再検討
	** 中心から遠い点を終点としているが、逆向きとして判定してしまう場合もある。


## 残作業
* 指針方向検出精度向上
* カメラ画像からの数値回転式メーターの検出
* 複数のメーター対応（同種類、別種類）

-------------------------------------------------------------------------------
## 補足

### キャリブレーションファイル項目
* テンプレート画像ファイルパス
* メーター最小値
* メーター最大値
* 最小値指針角度(度）※テンプレート画像右方向を始点とし、左回り（反時計回り）を正とする。
* 最大値までの角度(度) ※左回り（反時計回り）を正とする。
* 指針中心位置X(px)　※原点は左上、Y軸は下方向を正とする。
* 指針中心位置Y(px)
* 画像サイズ(幅)(px)
* 画像サイズ(高さ)(px)



### カメラのセットアップ

1. RaspberryPiにカメラを接続
2. 動作確認（デモ） => $ raspivid -d
3. Piccameraのインストール
    * OpenCVでは、RaspberryPiカメラを直接参照できない。（USBカメラはOK）
      pipでインストール + 
      $ pip install picamera
    * virtualenvを使用していて、パスが通っていない場合は以下のようにパスを通す。 +
      $ cd ~/.virtualenvs/cv-python3/lib/python3.5/site-packages + 
      $ ln /usr/lib/python3/dist-package/picamera  


### 参考URL
[OpenCV3とPython3で特徴点を抽出する]  
https://qiita.com/hitomatagi/items/62989573a30ec1d8180b

[いまさら局所特徴量で物体検出]  
https://qiita.com/hmichu/items/f5f1c778a155c7c414fd

[透視変換]  
https://qiita.com/ossyaritoori/items/f7bf63ad50028d1ee858

[特徴点のマッチング]
http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_feature2d/py_matcher/py_matcher.html
